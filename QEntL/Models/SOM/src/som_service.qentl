/**
 * @file som_service.qentl
 * @brief SOMæ¾éº¦ç»æµæ¨¡å‹æ ¸å¿ƒæœåŠ¡
 * 
 * é‡å­åŸºå› ç¼–ç : QGC-SOM-SERVICE-2025061801
 * é‡å­çº ç¼ ä¿¡é“: QEC-SOM-SERVICE-01
 * 
 * SOM(Songmai Economy Model)æ¾éº¦ç»æµæ¨¡å‹æ ¸å¿ƒæœåŠ¡
 * è´Ÿè´£é‡å­å¹³æƒç»æµã€æ¾éº¦å¸ç®¡ç†ã€ç»æµç³»ç»Ÿè¿è¡Œç­‰åŠŸèƒ½
 */

import "QEntL/core/console.qentl";
import "QEntL/core/string.qentl";
import "QEntL/core/array.qentl";
import "QEntL/core/map.qentl";
import "QEntL/core/time.qentl";
import "QEntL/core/math.qentl";
import "QEntL/core/crypto.qentl";

/**
 * @class SongmaiCoin
 * @brief æ¾éº¦å¸ç±»
 */
quantum_class SongmaiCoin {
    public coinId: String;
    public ownerId: String;
    public value: Float;
    public quantumSignature: String;
    public creationTime: Integer;
    public transactionHistory: Array<Transaction>;
    
    public function constructor(ownerId: String, value: Float) {
        this.coinId = "smc_" + Time.getCurrentTime() + "_" + Math.random();
        this.ownerId = ownerId;
        this.value = value;
        this.creationTime = Time.getCurrentTime();
        this.transactionHistory = new Array<Transaction>();
        this.quantumSignature = this.generateQuantumSignature();
    }
    
    private function generateQuantumSignature(): String {
        data = this.coinId + this.ownerId + this.value + this.creationTime;
        return "QS_SOM_" + Crypto.hash(data);
    }
    
    public function transfer(newOwnerId: String): Boolean {
        if (this.ownerId == newOwnerId) {
            return false;
        }
        
        transaction = new Transaction(this.ownerId, newOwnerId, this.value, "transfer");
        this.transactionHistory.push(transaction);
        this.ownerId = newOwnerId;
        
        Console.println("ğŸ’° æ¾éº¦å¸è½¬è´¦: " + this.value + " SOM -> " + newOwnerId);
        return true;
    }
}

/**
 * @class Transaction
 * @brief äº¤æ˜“è®°å½•ç±»
 */
quantum_class Transaction {
    public transactionId: String;
    public fromUserId: String;
    public toUserId: String;
    public amount: Float;
    public transactionType: String;
    public timestamp: Integer;
    public quantumProof: String;
    
    public function constructor(fromUserId: String, toUserId: String, amount: Float, transactionType: String) {
        this.transactionId = "tx_" + Time.getCurrentTime() + "_" + Math.random();
        this.fromUserId = fromUserId;
        this.toUserId = toUserId;
        this.amount = amount;
        this.transactionType = transactionType;
        this.timestamp = Time.getCurrentTime();
        this.quantumProof = this.generateQuantumProof();
    }
    
    private function generateQuantumProof(): String {
        data = this.transactionId + this.fromUserId + this.toUserId + this.amount;
        return "QP_" + Crypto.hash(data);
    }
}

/**
 * @class EconomicAccount
 * @brief ç»æµè´¦æˆ·ç±»
 */
quantum_class EconomicAccount {
    public userId: String;
    public balance: Float;
    public coins: Array<SongmaiCoin>;
    public contributionScore: Float;
    public socialWelfareLevel: Integer;
    public creationTime: Integer;
    
    public function constructor(userId: String) {
        this.userId = userId;
        this.balance = 0.0;
        this.coins = new Array<SongmaiCoin>();
        this.contributionScore = 0.0;
        this.socialWelfareLevel = 1;
        this.creationTime = Time.getCurrentTime();
    }
    
    public function addCoin(coin: SongmaiCoin): void {
        this.coins.push(coin);
        this.balance += coin.value;
        Console.println("ğŸ’ è´¦æˆ· " + this.userId + " è·å¾—æ¾éº¦å¸: " + coin.value + " SOM");
    }
    
    public function transferCoin(coinId: String, toUserId: String): Boolean {
        for (i = 0; i < this.coins.length; i++) {
            coin = this.coins[i];
            if (coin.coinId == coinId) {
                if (coin.transfer(toUserId)) {
                    this.coins.remove(i);
                    this.balance -= coin.value;
                    return true;
                }
            }
        }
        return false;
    }
    
    public function addContribution(score: Float, description: String): void {
        this.contributionScore += score;
        Console.println("ğŸŒŸ è´¦æˆ· " + this.userId + " è´¡çŒ®åº¦å¢åŠ : +" + score + " (" + description + ")");
        
        // æ ¹æ®è´¡çŒ®åº¦è°ƒæ•´ç¤¾ä¼šç¦åˆ©ç­‰çº§
        this.updateSocialWelfareLevel();
    }
    
    private function updateSocialWelfareLevel(): void {
        // æ ¹æ®è´¡çŒ®åº¦ç¡®å®šç¤¾ä¼šç¦åˆ©ç­‰çº§
        if (this.contributionScore >= 1000) {
            this.socialWelfareLevel = 5; // æœ€é«˜ç­‰çº§
        } else if (this.contributionScore >= 500) {
            this.socialWelfareLevel = 4;
        } else if (this.contributionScore >= 200) {
            this.socialWelfareLevel = 3;
        } else if (this.contributionScore >= 50) {
            this.socialWelfareLevel = 2;
        } else {
            this.socialWelfareLevel = 1; // åŸºç¡€ç­‰çº§
        }
    }
}

/**
 * @class EconomicEngine
 * @brief ç»æµå¼•æ“
 */
quantum_class EconomicEngine {
    private accounts: Map<String, EconomicAccount>;
    private totalSupply: Float;
    private distributionRules: Array<DistributionRule>;
    private welfarePrograms: Array<WelfareProgram>;
    
    public function constructor() {
        this.accounts = new Map<String, EconomicAccount>();
        this.totalSupply = 0.0;
        this.distributionRules = new Array<DistributionRule>();
        this.welfarePrograms = new Array<WelfareProgram>();
        
        this.initializeDistributionRules();
        this.initializeWelfarePrograms();
    }
    
    private function initializeDistributionRules(): void {
        // åŸºç¡€ä¿éšœåˆ†é…è§„åˆ™
        basicRule = new DistributionRule("åŸºç¡€ä¿éšœ", 100.0, "ç¡®ä¿æ¯äººåŸºæœ¬ç”Ÿæ´»éœ€æ±‚");
        this.distributionRules.push(basicRule);
        
        // è´¡çŒ®å¥–åŠ±åˆ†é…è§„åˆ™
        contributionRule = new DistributionRule("è´¡çŒ®å¥–åŠ±", 50.0, "æ ¹æ®ç¤¾ä¼šè´¡çŒ®å¥–åŠ±");
        this.distributionRules.push(contributionRule);
        
        Console.println("ğŸ“‹ ç»æµåˆ†é…è§„åˆ™åˆå§‹åŒ–å®Œæˆ");
    }
    
    private function initializeWelfarePrograms(): void {
        // åŸºç¡€åŒ»ç–—ä¿éšœ
        healthcareProgram = new WelfareProgram("åŸºç¡€åŒ»ç–—", "healthcare", "ä¿éšœå…¨æ°‘åŸºç¡€åŒ»ç–—éœ€æ±‚");
        this.welfarePrograms.push(healthcareProgram);
        
        // æ•™è‚²ä¿éšœ
        educationProgram = new WelfareProgram("æ•™è‚²ä¿éšœ", "education", "ä¿éšœå…¨æ°‘æ•™è‚²æƒåˆ©");
        this.welfarePrograms.push(educationProgram);
        
        // ä½æˆ¿ä¿éšœ
        housingProgram = new WelfareProgram("ä½æˆ¿ä¿éšœ", "housing", "ä¿éšœåŸºæœ¬ä½æˆ¿éœ€æ±‚");
        this.welfarePrograms.push(housingProgram);
        
        Console.println("ğŸ¥ ç¤¾ä¼šç¦åˆ©é¡¹ç›®åˆå§‹åŒ–å®Œæˆ");
    }
    
    public function createAccount(userId: String): Boolean {
        if (this.accounts.has(userId)) {
            return false;
        }
        
        account = new EconomicAccount(userId);
        this.accounts.set(userId, account);
        
        // å‘æ”¾åŸºç¡€ä¿éšœæ¾éº¦å¸
        this.distributeBasicAllowance(userId);
        
        Console.println("ğŸ¦ åˆ›å»ºç»æµè´¦æˆ·: " + userId);
        return true;
    }
    
    public function distributeBasicAllowance(userId: String): void {
        account = this.accounts.get(userId);
        if (account != null) {
            // å‘æ”¾åŸºç¡€ä¿éšœæ¾éº¦å¸
            basicAllowance = 100.0; // åŸºç¡€ä¿éšœé‡‘é¢
            coin = new SongmaiCoin(userId, basicAllowance);
            account.addCoin(coin);
            this.totalSupply += basicAllowance;
            
            Console.println("ğŸ å‘æ”¾åŸºç¡€ä¿éšœ: " + userId + " è·å¾— " + basicAllowance + " SOM");
        }
    }
    
    public function rewardContribution(userId: String, contributionType: String, amount: Float): void {
        account = this.accounts.get(userId);
        if (account != null) {
            // å¥–åŠ±è´¡çŒ®
            coin = new SongmaiCoin(userId, amount);
            account.addCoin(coin);
            account.addContribution(amount, contributionType);
            this.totalSupply += amount;
            
            Console.println("ğŸ† è´¡çŒ®å¥–åŠ±: " + userId + " å›  " + contributionType + " è·å¾— " + amount + " SOM");
        }
    }
    
    public function provideSocialWelfare(userId: String, welfareType: String): Boolean {
        account = this.accounts.get(userId);
        if (account == null) {
            return false;
        }
        
        // æ ¹æ®ç¤¾ä¼šç¦åˆ©ç­‰çº§æä¾›æœåŠ¡
        program = this.findWelfareProgram(welfareType);
        if (program != null) {
            serviceCost = program.calculateCost(account.socialWelfareLevel);
            
            if (account.balance >= serviceCost) {
                // æ‰£é™¤è´¹ç”¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
                // account.balance -= serviceCost;
                Console.println("ğŸ¥ æä¾›ç¤¾ä¼šç¦åˆ©: " + userId + " è·å¾— " + welfareType + " æœåŠ¡");
                return true;
            } else {
                // å¦‚æœä½™é¢ä¸è¶³ï¼Œä»ç„¶æä¾›åŸºç¡€æœåŠ¡ï¼ˆä½“ç°å¹³æƒç»æµï¼‰
                Console.println("ğŸ†“ å…è´¹æä¾›åŸºç¡€ç¦åˆ©: " + userId + " è·å¾—åŸºç¡€ " + welfareType + " æœåŠ¡");
                return true;
            }
        }
        
        return false;
    }
    
    private function findWelfareProgram(welfareType: String): WelfareProgram {
        for (i = 0; i < this.welfarePrograms.length; i++) {
            program = this.welfarePrograms[i];
            if (program.programType == welfareType) {
                return program;
            }
        }
        return null;
    }
    
    public function transferSongmaiCoin(fromUserId: String, toUserId: String, amount: Float): Boolean {
        fromAccount = this.accounts.get(fromUserId);
        toAccount = this.accounts.get(toUserId);
        
        if (fromAccount == null || toAccount == null || fromAccount.balance < amount) {
            return false;
        }
        
        // æ‰¾åˆ°åˆé€‚çš„æ¾éº¦å¸è¿›è¡Œè½¬è´¦
        remainingAmount = amount;
        coinsToTransfer = new Array<SongmaiCoin>();
        
        for (i = 0; i < fromAccount.coins.length && remainingAmount > 0; i++) {
            coin = fromAccount.coins[i];
            if (coin.value <= remainingAmount) {
                coinsToTransfer.push(coin);
                remainingAmount -= coin.value;
            }
        }
        
        // æ‰§è¡Œè½¬è´¦
        for (i = 0; i < coinsToTransfer.length; i++) {
            coin = coinsToTransfer[i];
            if (fromAccount.transferCoin(coin.coinId, toUserId)) {
                toAccount.addCoin(coin);
            }
        }
        
        Console.println("ğŸ’¸ æ¾éº¦å¸è½¬è´¦: " + fromUserId + " -> " + toUserId + " é‡‘é¢: " + amount + " SOM");
        return true;
    }
    
    public function getEconomicReport(): String {
        report = "SOMç»æµç³»ç»ŸæŠ¥å‘Š:\n";
        report += "æ€»è´¦æˆ·æ•°: " + this.accounts.size() + "\n";
        report += "æ¾éº¦å¸æ€»ä¾›åº”é‡: " + this.totalSupply + " SOM\n";
        report += "åˆ†é…è§„åˆ™æ•°: " + this.distributionRules.length + "\n";
        report += "ç¦åˆ©é¡¹ç›®æ•°: " + this.welfarePrograms.length + "\n";
        
        // ç»Ÿè®¡ä¸åŒç¦åˆ©ç­‰çº§çš„ç”¨æˆ·
        welfareStats = new Array<Integer>(6);
        for (userId in this.accounts.keys()) {
            account = this.accounts.get(userId);
            welfareStats[account.socialWelfareLevel]++;
        }
        
        report += "ç¤¾ä¼šç¦åˆ©ç­‰çº§åˆ†å¸ƒ:\n";
        for (level = 1; level <= 5; level++) {
            report += "  ç­‰çº§" + level + ": " + welfareStats[level] + " äºº\n";
        }
        
        return report;
    }
}

/**
 * @class DistributionRule
 * @brief åˆ†é…è§„åˆ™ç±»
 */
quantum_class DistributionRule {
    public name: String;
    public amount: Float;
    public description: String;
    
    public function constructor(name: String, amount: Float, description: String) {
        this.name = name;
        this.amount = amount;
        this.description = description;
    }
}

/**
 * @class WelfareProgram
 * @brief ç¦åˆ©é¡¹ç›®ç±»
 */
quantum_class WelfareProgram {
    public name: String;
    public programType: String;
    public description: String;
    
    public function constructor(name: String, programType: String, description: String) {
        this.name = name;
        this.programType = programType;
        this.description = description;
    }
    
    public function calculateCost(welfareLevel: Integer): Float {
        // æ ¹æ®ç¦åˆ©ç­‰çº§è®¡ç®—æœåŠ¡æˆæœ¬
        baseCost = 10.0;
        
        // ç­‰çº§è¶Šé«˜ï¼Œä¸ªäººæ‰¿æ‹…æˆæœ¬è¶Šä½ï¼ˆä½“ç°ç¤¾ä¼šè´¡çŒ®çš„å›æŠ¥ï¼‰
        switch (welfareLevel) {
            case 5: return 0.0;      // æœ€é«˜ç­‰çº§å…è´¹
            case 4: return baseCost * 0.2;
            case 3: return baseCost * 0.5;
            case 2: return baseCost * 0.8;
            default: return baseCost; // åŸºç¡€ç­‰çº§
        }
    }
}

/**
 * @class SOMService
 * @brief SOMæ¾éº¦ç»æµæ¨¡å‹ä¸»æœåŠ¡
 */
quantum_class SOMService {
    private economicEngine: EconomicEngine;
    private isRunning: Boolean;
    
    public function constructor() {
        this.economicEngine = new EconomicEngine();
        this.isRunning = false;
    }
    
    public function initialize(): Boolean {
        Console.println("ğŸš€ åˆå§‹åŒ–SOMæ¾éº¦ç»æµæ¨¡å‹æœåŠ¡...");
        Console.println("é‡å­åŸºå› ç¼–ç : QGC-SOM-SERVICE-2025061801");
        Console.println("========================================");
        
        Console.println("ğŸ’° é‡å­å¹³æƒç»æµç³»ç»Ÿå¯åŠ¨");
        Console.println("ğŸ¯ ç›®æ ‡: ä¿éšœå…¨äººç±»ç”Ÿå‘½ã€å¥åº·ã€ç”Ÿæ´»");
        
        this.isRunning = true;
        Console.println("âœ… SOMæœåŠ¡åˆå§‹åŒ–å®Œæˆ");
        return true;
    }
    
    public function createEconomicAccount(userId: String): Boolean {
        return this.economicEngine.createAccount(userId);
    }
    
    public function rewardContribution(userId: String, contributionType: String, amount: Float): void {
        this.economicEngine.rewardContribution(userId, contributionType, amount);
    }
    
    public function provideSocialWelfare(userId: String, welfareType: String): Boolean {
        return this.economicEngine.provideSocialWelfare(userId, welfareType);
    }
    
    public function transferSongmaiCoin(fromUserId: String, toUserId: String, amount: Float): Boolean {
        return this.economicEngine.transferSongmaiCoin(fromUserId, toUserId, amount);
    }
    
    public function distributeBasicAllowance(userId: String): void {
        this.economicEngine.distributeBasicAllowance(userId);
    }
    
    public function getSystemStatus(): String {
        status = "SOMç³»ç»ŸçŠ¶æ€æŠ¥å‘Š:\n";
        status += "è¿è¡ŒçŠ¶æ€: " + (this.isRunning ? "è¿è¡Œä¸­" : "å·²åœæ­¢") + "\n";
        status += this.economicEngine.getEconomicReport();
        status += "é‡å­åŸºå› ç¼–ç : QGC-SOM-SERVICE-2025061801\n";
        return status;
    }
    
    public function shutdown(): void {
        Console.println("ğŸ”„ å…³é—­SOMæœåŠ¡...");
        this.isRunning = false;
        Console.println("âœ… SOMæœåŠ¡å·²å…³é—­");
    }
    
    public static function main(): Integer {
        Console.println("SOMæ¾éº¦ç»æµæ¨¡å‹æœåŠ¡å¯åŠ¨");
        
        service = new SOMService();
        if (!service.initialize()) {
            Console.println("âŒ æœåŠ¡åˆå§‹åŒ–å¤±è´¥");
            return 1;
        }
        
        // æ¼”ç¤ºåŠŸèƒ½
        Console.println("\nğŸ§ª æ¼”ç¤ºSOMæ ¸å¿ƒåŠŸèƒ½:");
        
        // åˆ›å»ºç»æµè´¦æˆ·
        service.createEconomicAccount("user1");
        service.createEconomicAccount("user2");
        
        // å¥–åŠ±è´¡çŒ®
        service.rewardContribution("user1", "æŠ€æœ¯åˆ›æ–°", 200.0);
        service.rewardContribution("user2", "ç¤¾ä¼šæœåŠ¡", 150.0);
        
        // è½¬è´¦æµ‹è¯•
        service.transferSongmaiCoin("user1", "user2", 50.0);
        
        // æä¾›ç¤¾ä¼šç¦åˆ©
        service.provideSocialWelfare("user1", "healthcare");
        service.provideSocialWelfare("user2", "education");
        
        // å‘æ”¾åŸºç¡€ä¿éšœ
        service.distributeBasicAllowance("user1");
        
        // æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
        Console.println("\n" + service.getSystemStatus());
        
        // å…³é—­æœåŠ¡
        service.shutdown();
        
        return 0;
    }
}
