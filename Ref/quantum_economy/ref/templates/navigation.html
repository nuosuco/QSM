<!-- 松麦统一导航栏模板 -->
<!-- 在所有松麦子系统页面头部包含此模板 -->

<nav class="som-navigation">
    <div class="nav-container">
        <!-- 松麦Logo -->
        <div class="nav-logo">
            <a href="/som">
                <img src="/static/images/som-logo.svg" alt="松麦Logo">
                <span>松麦</span>
            </a>
        </div>
        
        <!-- 核心系统导航链接 -->
        <ul class="nav-links">
            <li class="nav-item" data-system="blockchain">
                <a href="/som/blockchain">主量子区块链</a>
            </li>
            <li class="nav-item" data-system="somchain">
                <a href="/som/somchain">松麦子链</a>
            </li>
            <li class="nav-item" data-system="traceability">
                <a href="/som/traceability">追溯系统</a>
            </li>
            <li class="nav-item" data-system="wallet">
                <a href="/som/wallet">松麦钱包</a>
            </li>
            <li class="nav-item" data-system="coin">
                <a href="/som/coin">松麦币</a>
            </li>
            <li class="nav-item" data-system="marketplace">
                <a href="/som/marketplace">生态商城</a>
            </li>
        </ul>
        
        <!-- 用户交互区 -->
        <div class="nav-user-area">
            <!-- 量子态阵图 -->
            <div class="quantum-matrix-button" id="quantum-matrix-toggle">
                <svg width="24" height="24" viewBox="0 0 24 24" class="quantum-matrix-icon">
                    <rect x="2" y="2" width="6" height="6" rx="1" />
                    <rect x="9" y="2" width="6" height="6" rx="1" />
                    <rect x="16" y="2" width="6" height="6" rx="1" />
                    <rect x="2" y="9" width="6" height="6" rx="1" />
                    <rect x="9" y="9" width="6" height="6" rx="1" />
                    <rect x="16" y="9" width="6" height="6" rx="1" />
                    <rect x="2" y="16" width="6" height="6" rx="1" />
                    <rect x="9" y="16" width="6" height="6" rx="1" />
                    <rect x="16" y="16" width="6" height="6" rx="1" />
                </svg>
            </div>
            
            <!-- 用户登录按钮 -->
            <div class="user-login" id="user-login-container">
                <a href="/som/user/login" class="login-button" id="login-button">登录</a>
                <!-- 登录后显示的用户菜单将通过JavaScript动态插入 -->
            </div>
        </div>
    </div>
</nav>

<!-- 量子态多模态交互面板 -->
<div class="quantum-matrix-panel" id="quantum-matrix-panel">
    <div class="panel-header">
        <h3>多模态交互</h3>
        <button type="button" class="close-button" id="close-quantum-panel">&times;</button>
    </div>
    
    <div class="modal-matrix">
        <!-- 九宫格式的多模态交互选项 -->
        <div class="modal-row">
            <div class="modal-cell" data-mode="text">
                <i class="mode-icon text-icon"></i>
                <span>文本</span>
            </div>
            <div class="modal-cell" data-mode="click">
                <i class="mode-icon click-icon"></i>
                <span>点击</span>
            </div>
            <div class="modal-cell" data-mode="voice">
                <i class="mode-icon voice-icon"></i>
                <span>声音</span>
            </div>
        </div>
        
        <div class="modal-row">
            <div class="modal-cell" data-mode="image">
                <i class="mode-icon image-icon"></i>
                <span>图像</span>
            </div>
            <div class="modal-cell" data-mode="motion">
                <i class="mode-icon motion-icon"></i>
                <span>动作</span>
            </div>
            <div class="modal-cell" data-mode="video">
                <i class="mode-icon video-icon"></i>
                <span>视频</span>
            </div>
        </div>
        
        <div class="modal-row">
            <div class="modal-cell" data-mode="brainwave">
                <i class="mode-icon brainwave-icon"></i>
                <span>脑波</span>
            </div>
            <div class="modal-cell" data-mode="file">
                <i class="mode-icon file-icon"></i>
                <span>文件</span>
            </div>
            <div class="modal-cell" data-mode="vector">
                <i class="mode-icon vector-icon"></i>
                <span>向量</span>
            </div>
        </div>
    </div>
    
    <!-- 选中的交互模式面板将动态加载到这里 -->
    <div class="interaction-container" id="interaction-container"></div>
</div>

<!-- 导航栏样式 -->
<style>
:root {
    --som-primary: #0052cc;
    --som-secondary: #00875a;
    --som-background: #f5f7fa;
    --som-text: #172b4d;
    --som-border: #dfe1e6;
    --som-hover: #ebecf0;
}

.som-navigation {
    background-color: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    height: 60px;
}

.nav-container {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    height: 100%;
    padding: 0 20px;
}

.nav-logo {
    margin-right: 30px;
}

.nav-logo a {
    display: flex;
    align-items: center;
    text-decoration: none;
}

.nav-logo img {
    height: 36px;
    margin-right: 10px;
}

.nav-logo span {
    font-size: 18px;
    font-weight: 600;
    color: var(--som-primary);
}

.nav-links {
    display: flex;
    list-style: none;
    margin: 0;
    padding: 0;
    flex-grow: 1;
}

.nav-item {
    margin: 0 5px;
}

.nav-item a {
    display: block;
    padding: 8px 12px;
    color: var(--som-text);
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.nav-item a:hover {
    background-color: var(--som-hover);
}

.nav-item.active a {
    color: var(--som-primary);
    font-weight: 600;
}

.nav-user-area {
    display: flex;
    align-items: center;
}

.quantum-matrix-button {
    margin-right: 15px;
    cursor: pointer;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
}

.quantum-matrix-button:hover {
    background-color: var(--som-hover);
}

.quantum-matrix-icon {
    fill: none;
    stroke: var(--som-primary);
    stroke-width: 1.5;
}

.login-button {
    display: block;
    padding: 8px 16px;
    background-color: var(--som-primary);
    color: white;
    border-radius: 4px;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s;
}

.login-button:hover {
    background-color: #0747a6;
}

/* 量子态多模态交互面板样式 */
.quantum-matrix-panel {
    position: fixed;
    top: 70px;
    right: 20px;
    width: 320px;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1001;
    display: none;
    overflow: hidden;
}

.quantum-matrix-panel.active {
    display: block;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--som-border);
}

.panel-header h3 {
    margin: 0;
    font-size: 16px;
    color: var(--som-text);
}

.close-button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 20px;
    color: #6b778c;
}

.modal-matrix {
    padding: 16px;
}

.modal-row {
    display: flex;
    margin-bottom: 8px;
}

.modal-row:last-child {
    margin-bottom: 0;
}

.modal-cell {
    flex: 1;
    height: 70px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
    margin: 0 4px;
}

.modal-cell:hover {
    background-color: var(--som-hover);
}

.mode-icon {
    width: 24px;
    height: 24px;
    margin-bottom: 8px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
}

.modal-cell span {
    font-size: 12px;
    color: var(--som-text);
}

.interaction-container {
    border-top: 1px solid var(--som-border);
    padding: 16px;
    max-height: 300px;
    overflow-y: auto;
    display: none;
}

.interaction-container.active {
    display: block;
}
</style>

<!-- 导航栏脚本 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 设置当前页面的活动状态
    const currentPath = window.location.pathname;
    document.querySelectorAll('.nav-item').forEach(item => {
        const link = item.querySelector('a');
        if (currentPath.includes(item.dataset.system)) {
            item.classList.add('active');
        }
    });
    
    // 量子态阵图面板切换
    const matrixToggle = document.getElementById('quantum-matrix-toggle');
    const matrixPanel = document.getElementById('quantum-matrix-panel');
    const closePanel = document.getElementById('close-quantum-panel');
    
    matrixToggle.addEventListener('click', function() {
        matrixPanel.classList.toggle('active');
        
        // 向其他系统发送状态更新
        if (window.somSyncWebSocket && matrixPanel.classList.contains('active')) {
            broadcastPanelState('open');
        } else if (window.somSyncWebSocket) {
            broadcastPanelState('closed');
        }
    });
    
    closePanel.addEventListener('click', function() {
        matrixPanel.classList.remove('active');
        
        // 向其他系统发送状态更新
        if (window.somSyncWebSocket) {
            broadcastPanelState('closed');
        }
    });
    
    // 多模态交互选项点击处理
    const modalCells = document.querySelectorAll('.modal-cell');
    const interactionContainer = document.getElementById('interaction-container');
    
    modalCells.forEach(cell => {
        cell.addEventListener('click', function() {
            const mode = this.dataset.mode;
            loadInteractionMode(mode);
            
            // 向其他系统发送交互模式更新
            if (window.somSyncWebSocket) {
                broadcastInteractionMode(mode);
            }
        });
    });
    
    // 加载交互模式
    function loadInteractionMode(mode) {
        // 先清空当前内容
        interactionContainer.innerHTML = '';
        
        // 显示交互容器
        interactionContainer.classList.add('active');
        
        // 异步加载指定模式的交互内容
        fetch(`/api/som/interaction_panel/${mode}`)
            .then(response => response.text())
            .then(html => {
                interactionContainer.innerHTML = html;
                // 初始化交互模式相关的脚本
                initInteractionMode(mode);
            })
            .catch(error => {
                interactionContainer.innerHTML = `<p>加载失败: ${error.message}</p>`;
            });
    }
    
    // 初始化各种交互模式的特定功能
    function initInteractionMode(mode) {
        // 根据不同模式初始化不同功能
        switch(mode) {
            case 'text':
                initTextInteraction();
                break;
            case 'voice':
                initVoiceInteraction();
                break;
            // 其他模式的初始化...
        }
    }
    
    // 文本交互模式初始化
    function initTextInteraction() {
        const textInput = document.querySelector('.text-interaction-input');
        const sendButton = document.querySelector('.text-interaction-send');
        
        if (textInput && sendButton) {
            sendButton.addEventListener('click', function() {
                const text = textInput.value.trim();
                if (text) {
                    // 发送文本到服务器处理
                    sendTextInteraction(text);
                    textInput.value = '';
                }
            });
            
            textInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendButton.click();
                }
            });
        }
    }
    
    // 语音交互模式初始化
    function initVoiceInteraction() {
        // 实际的语音识别代码需要具体实现
    }
    
    // 发送文本交互请求
    function sendTextInteraction(text) {
        fetch('/api/som/interaction/text', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ text: text })
        })
        .then(response => response.json())
        .then(data => {
            // 处理响应
            const responseContainer = document.querySelector('.text-interaction-responses');
            if (responseContainer) {
                const userMsg = document.createElement('div');
                userMsg.className = 'interaction-message user-message';
                userMsg.textContent = text;
                
                const systemMsg = document.createElement('div');
                systemMsg.className = 'interaction-message system-message';
                systemMsg.textContent = data.response;
                
                responseContainer.appendChild(userMsg);
                responseContainer.appendChild(systemMsg);
                responseContainer.scrollTop = responseContainer.scrollHeight;
            }
        })
        .catch(error => {
            console.error('交互请求失败:', error);
        });
    }
    
    // 向其他系统广播面板状态
    function broadcastPanelState(state) {
        const message = {
            type: 'panel_state',
            source: 'som_nav_modal',
            state: state
        };
        
        window.somSyncWebSocket.send(JSON.stringify(message));
    }
    
    // 向其他系统广播交互模式
    function broadcastInteractionMode(mode) {
        const message = {
            type: 'interaction_mode',
            source: 'som_nav_modal',
            mode: mode
        };
        
        window.somSyncWebSocket.send(JSON.stringify(message));
    }
    
    // 初始化WebSocket连接
    function initSyncWebSocket() {
        const ws = new WebSocket(`ws://${window.location.host}/ws/som_sync`);
        
        ws.onopen = function() {
            console.log('同步WebSocket连接已建立');
        };
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            // 处理来自其他系统的同步消息
            if (data.source !== 'som_nav_modal') {
                if (data.type === 'panel_state') {
                    if (data.state === 'open') {
                        matrixPanel.classList.add('active');
                    } else {
                        matrixPanel.classList.remove('active');
                    }
                } else if (data.type === 'interaction_mode') {
                    loadInteractionMode(data.mode);
                }
            }
        };
        
        ws.onclose = function() {
            console.log('同步WebSocket连接已关闭');
            // 尝试重新连接
            setTimeout(initSyncWebSocket, 3000);
        };
        
        ws.onerror = function(error) {
            console.error('WebSocket错误:', error);
        };
        
        window.somSyncWebSocket = ws;
    }
    
    // 初始化同步WebSocket
    initSyncWebSocket();
    
    // 检查并显示用户登录状态
    checkUserLoginStatus();
    
    // 检查用户登录状态
    function checkUserLoginStatus() {
        const token = localStorage.getItem('som_user_token');
        
        if (token) {
            // 验证token
            fetch('/api/som/user/verify_token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    showLoggedInUser(data.user);
                } else {
                    showLoginButton();
                    // 清除无效token
                    localStorage.removeItem('som_user_token');
                }
            })
            .catch(error => {
                console.error('验证用户失败:', error);
                showLoginButton();
            });
        } else {
            showLoginButton();
        }
    }
    
    // 显示已登录用户信息
    function showLoggedInUser(user) {
        const container = document.getElementById('user-login-container');
        
        container.innerHTML = `
            <div class="user-profile-menu">
                <div class="user-avatar">
                    <img src="${user.avatar || '/static/images/default-avatar.png'}" alt="${user.username}">
                </div>
                <span class="user-name">${user.username}</span>
                <div class="user-dropdown">
                    <a href="/som/user/profile">个人中心</a>
                    <a href="/som/user/wallet">我的钱包</a>
                    <a href="/som/user/settings">设置</a>
                    <a href="#" id="logout-button">退出登录</a>
                </div>
            </div>
        `;
        
        // 添加退出登录事件
        document.getElementById('logout-button').addEventListener('click', function(e) {
            e.preventDefault();
            logoutUser();
        });
        
        // 用户菜单切换
        const profileMenu = document.querySelector('.user-profile-menu');
        profileMenu.addEventListener('click', function() {
            this.classList.toggle('active');
        });
    }
    
    // 显示登录按钮
    function showLoginButton() {
        const container = document.getElementById('user-login-container');
        container.innerHTML = `<a href="/som/user/login" class="login-button" id="login-button">登录</a>`;
    }
    
    // 用户退出登录
    function logoutUser() {
        localStorage.removeItem('som_user_token');
        showLoginButton();
        
        // 提示用户已退出登录
        alert('您已成功退出登录');
        
        // 可选: 重定向到首页
        // window.location.href = '/som';
    }
});
</script> 

<!--

<!--
量子基因编码: QE-NAV-D2EF963C3ADA
纠缠状态: 活跃
纠缠对象: ['Ref/ref_core.py']
纠缠强度: 0.98
-->
-->

// 开发团队：中华 ZhoHo ，Claude 
